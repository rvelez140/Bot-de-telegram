{% extends "base.html" %}

{% block title %}GestiÃ³n de Cuentas - Video Downloader{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1>ğŸ” GestiÃ³n de Cuentas</h1>
        <p>Configura tus cuentas de redes sociales para descargar contenido privado</p>
    </div>

    <!-- Agregar nueva cuenta -->
    <div class="card">
        <h2>â• Agregar Cuenta</h2>

        <form id="addAccountForm">
            <div class="form-group">
                <label for="platform">Plataforma</label>
                <select id="platform" name="platform" required>
                    <option value="">Selecciona una plataforma</option>
                    <option value="twitter">ğŸ¦ Twitter/X</option>
                    <!-- Futuras plataformas -->
                    <!-- <option value="instagram">ğŸ“· Instagram</option> -->
                </select>
            </div>

            <div class="form-group">
                <label for="platform_username">Usuario o Email</label>
                <input type="text" id="platform_username" name="platform_username" placeholder="tu_usuario o email@ejemplo.com" required>
            </div>

            <div class="form-group">
                <label for="platform_password">ContraseÃ±a</label>
                <input type="password" id="platform_password" name="platform_password" required>
                <small class="text-warning">âš ï¸ Tu contraseÃ±a no se guarda. Solo se usan cookies de sesiÃ³n.</small>
            </div>

            <button type="submit" class="btn btn-primary" id="addAccountBtn">
                Agregar Cuenta
            </button>
        </form>

        <div id="addAccountStatus" class="download-status" style="display: none;"></div>
    </div>

    <!-- Cuentas configuradas -->
    <div class="card">
        <h2>ğŸ“‹ Cuentas Configuradas</h2>

        {% if accounts %}
        <div class="accounts-grid">
            {% for account in accounts %}
            <div class="account-card">
                <div class="account-card-header">
                    <span class="account-platform-icon">
                        {% if account.platform == 'twitter' %}ğŸ¦{% endif %}
                    </span>
                    <h3>
                        {% if account.platform == 'twitter' %}Twitter/X{% endif %}
                    </h3>
                </div>
                <div class="account-card-body">
                    <p><strong>Usuario:</strong> @{{ account.platform_username }}</p>
                    <p><small>Agregada: {{ account.created_at }}</small></p>
                    <p><small>Actualizada: {{ account.updated_at }}</small></p>
                </div>
                <div class="account-card-footer">
                    <button class="btn btn-danger btn-sm" onclick="deleteAccount('{{ account.platform }}')">
                        Eliminar
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <p>ğŸ”“ No tienes cuentas configuradas</p>
            <p>Agrega una cuenta arriba para poder descargar contenido privado de redes sociales.</p>
        </div>
        {% endif %}
    </div>

    <!-- InformaciÃ³n de seguridad -->
    <div class="card card-info">
        <h3>ğŸ”’ InformaciÃ³n de Seguridad</h3>
        <ul>
            <li>âœ… <strong>No guardamos contraseÃ±as:</strong> Solo se usan para generar cookies de sesiÃ³n</li>
            <li>âœ… <strong>Cookies seguras:</strong> Las cookies se almacenan cifradas en la base de datos</li>
            <li>âœ… <strong>Sesiones privadas:</strong> Solo tÃº tienes acceso a tus cuentas configuradas</li>
            <li>âœ… <strong>Puedes eliminar en cualquier momento:</strong> Tus datos se borran completamente</li>
        </ul>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Agregar cuenta
document.getElementById('addAccountForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const btn = document.getElementById('addAccountBtn');
    const status = document.getElementById('addAccountStatus');
    const formData = new FormData(this);

    btn.disabled = true;
    btn.textContent = 'Procesando...';
    status.style.display = 'block';
    status.className = 'download-status status-loading';
    status.innerHTML = 'â³ Iniciando sesiÃ³n en la plataforma...';

    try {
        const response = await fetch('{{ url_for("add_account") }}', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            status.className = 'download-status status-success';
            status.innerHTML = 'âœ… ' + data.message;

            // Limpiar formulario
            document.getElementById('addAccountForm').reset();

            // Recargar pÃ¡gina despuÃ©s de 2 segundos
            setTimeout(() => {
                window.location.reload();
            }, 2000);

        } else {
            status.className = 'download-status status-error';
            status.innerHTML = 'âŒ ' + data.error;
        }

    } catch (error) {
        status.className = 'download-status status-error';
        status.innerHTML = 'âŒ Error: ' + error.message;
    } finally {
        btn.disabled = false;
        btn.textContent = 'Agregar Cuenta';
    }
});

// Eliminar cuenta
async function deleteAccount(platform) {
    if (!confirm('Â¿EstÃ¡s seguro de que deseas eliminar esta cuenta?')) {
        return;
    }

    try {
        const formData = new FormData();
        formData.append('platform', platform);

        const response = await fetch('{{ url_for("delete_account") }}', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            alert('âœ… Cuenta eliminada exitosamente');
            window.location.reload();
        } else {
            alert('âŒ Error: ' + data.error);
        }

    } catch (error) {
        alert('âŒ Error: ' + error.message);
    }
}
</script>
{% endblock %}
